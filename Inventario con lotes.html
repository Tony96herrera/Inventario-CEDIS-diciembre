<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario con lotes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        /* Reset y fuentes */
        * {margin:0;padding:0;box-sizing:border-box;}
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(120deg, #e0e7ff 0%, #f8fafc 100%);
            min-height: 100vh;
            padding: 0;
        }
        .container {
            max-width: 1400px;
            margin: 40px auto 0 auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(60,72,100,0.10);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
            color: #fff;
            padding: 38px 32px 32px 32px;
            text-align: left;
            position: relative;
            border-bottom-left-radius: 32px;
            border-bottom-right-radius: 32px;
            box-shadow: 0 4px 24px rgba(60,72,100,0.08);
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .header .menu-hamburguesa {
            position: static;
            margin-right: 12px;
            width: 34px;
            height: 34px;
            min-width: 34px;
            min-height: 34px;
            background: rgba(255,255,255,0.13);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 110;
            transition: background 0.2s;
            border: none;
        }
        .header .menu-hamburguesa:active {
            background: rgba(255,255,255,0.22);
        }
        .menu-hamburguesa span, .menu-hamburguesa span:before, .menu-hamburguesa span:after {
            display: block;
            background: #fff;
            height: 3px;
            width: 20px;
            border-radius: 2px;
            position: absolute;
            transition: all 0.3s;
        }
        .menu-hamburguesa span {
            position: relative;
        }
        .menu-hamburguesa span:before {
            content: '';
            top: -7px;
            position: absolute;
        }
        .menu-hamburguesa span:after {
            content: '';
            top: 7px;
            position: absolute;
        }
        .header-content {
            flex: 1;
        }
        .header h1 {
            font-size: 2.3rem;
            margin-bottom: 6px;
            font-weight: 800;
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header h1 .icon {
            font-size: 2.2rem;
            margin-right: 2px;
        }
        .header p {
            font-size: 1.1rem;
            opacity: 0.92;
            font-weight: 500;
        }
        .side-menu {
            position: fixed;
            top: 0;
            left: -200px; /* oculto fuera de vista */
            width: 200px; /* barra azul más ancha */
            height: 100%;
            background: linear-gradient(135deg,#6366f1 0%,#60a5fa 100%);
            color: #fff;
            box-shadow: 2px 0 16px rgba(60,72,100,0.10);
            z-index: 2000;
            transition: left 0.3s;
            padding-top: 50px;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
        }
        .side-menu.open { left: 0; }
        .side-menu ul {
            list-style: none;
            padding: 0 0 0 16px;
        }
        .side-menu li {
            margin-bottom: 18px;
        }
        .side-menu a {
            color: #fff;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            transition: color 0.2s;
        }
        .side-menu a:hover {
            color: #fbbf24;
        }
        .side-menu .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .side-menu .menu-title {
            font-size: 1.05rem;
            font-weight: bold;
            margin-bottom: 18px;
            margin-left: 4px;
        }
        .upload-section {
            padding: 32px 32px 24px 32px;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
        }
        .upload-zone {
            border: 3px dashed #6366f1;
            border-radius: 16px;
            padding: 40px 20px;
            background: #fff;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #60a5fa;
            background: #f8fafc;
            transform: scale(1.02);
        }
        .upload-zone.has-file {
            border-color: #22c55e;
            background: #f0fdf4;
        }
        .upload-icon {
            font-size: 3rem;
            color: #6366f1;
            margin-bottom: 12px;
        }
        .upload-text {
            font-size: 1.2rem;
            color: #4b5563;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .upload-subtext {
            font-size: 0.95rem;
            color: #6b7280;
        }
        .file-input {
            display: none;
        }
        .controls {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0;
        }
        .btn {
            padding: 11px 22px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(60,72,100,0.06);
        }
        .btn:hover {
            transform: translateY(-1px) scale(1.03);
            box-shadow: 0 4px 16px rgba(60,72,100,0.10);
        }
        .btn-primary {background: #60a5fa; color: #fff;}
        .btn-success {background: #22c55e; color: #fff;}
        .btn-warning {background: #fbbf24; color: #fff;}
        .btn-danger {background: #ef4444; color: #fff;}
        .btn-info {background: #8b5cf6; color: #fff;}
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        /* Barra de acciones secundaria (nueva) */
        .action-toolbar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 12px;
            background: linear-gradient(90deg, #60a5fa14 0%, #6366f114 100%);
            border: 1px solid #e5e7eb;
            padding: 12px 14px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(60,72,100,0.06);
        }
        .action-toolbar .btn { box-shadow: 0 2px 8px rgba(60,72,100,0.06); }
        .action-toolbar .btn:hover { transform: translateY(-1px) scale(1.03); }
        
        .data-analysis-section {
            padding: 24px 32px;
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            display: none;
        }
        .data-analysis-section.show {
            display: block;
        }
        
        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .column-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }
        
        .column-card:hover {
            box-shadow: 0 4px 12px rgba(60,72,100,0.08);
            transform: translateY(-2px);
        }
        
        .column-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 12px;
        }
        
        .column-name {
            font-weight: 700;
            color: #6366f1;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex: 1;
        }
        
        .column-type {
            background: #6366f1;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .column-stats {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .unique-values {
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.85rem;
        }
        
        .value-item {
            background: #e5e7eb;
            color: #374151;
            padding: 3px 8px;
            margin: 2px;
            border-radius: 6px;
            display: inline-block;
            font-weight: 500;
        }
        
        .search-container {
            padding: 18px 32px 18px 32px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: none;
        }
        .search-container.show {
            display: block;
        }
        .search-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
        }
        .search-box {
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 13px 46px 13px 18px;
            border: 1.5px solid #e5e7eb;
            border-radius: 22px;
            font-size: 1rem;
            background: #fff;
            transition: all 0.2s;
        }
        .search-box input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px #6366f122;
        }
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a5b4fc;
            font-size: 1.3rem;
        }
        
        .filter-select {
            padding: 10px 16px;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            background: #fff;
            font-size: 0.95rem;
            min-width: 150px;
        }
        
        .table-container {
            max-height: 600px;
            overflow: auto;
            margin: 0 32px 32px 32px;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(60,72,100,0.06);
            background: #fff;
            display: none;
        }
        .table-container.show {
            display: block;
        }
        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            min-width: 800px;
        }
        .dynamic-table th {
            background: #6366f1;
            color: #fff;
            padding: 12px 8px;
            text-align: left;
            font-weight: 700;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            border-right: 1px solid #5b5fc7;
        }
        .dynamic-table th:last-child {
            border-right: none;
        }
        .dynamic-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
            border-right: 1px solid #f3f4f6;
            vertical-align: middle;
            font-size: 0.95rem;
            max-width: 300px;
            word-wrap: break-word;
        }
        .dynamic-table td:last-child {
            border-right: none;
        }
        .dynamic-table tr:hover {
            background: #f3f4f6;
            transition: all 0.2s;
        }
        .dynamic-table tr:nth-child(even) {
            background: #f9fafb;
        }
        .dynamic-table tr:nth-child(even):hover {
            background: #f3f4f6;
        }
        .editable-cell {
            background: #fff;
            border: 1.5px solid #6366f1;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 1rem;
            width: 80px;
            min-width: 60px;
            max-width: 120px;
            color: #222;
            box-shadow: none;
            outline: none;
            transition: border 0.2s, box-shadow 0.2s;
            text-align: right;
            /* Elimina las flechas de los inputs number en Chrome/Safari/Edge */
        }
        .editable-cell:focus {
            border-color: #4338ca;
            box-shadow: 0 0 0 2px #6366f122;
        }
        /* Quitar flechas de number en Chrome/Safari/Edge */
        input[type=number].editable-cell::-webkit-inner-spin-button,
        input[type=number].editable-cell::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Quitar flechas de number en Firefox */
        input[type=number].editable-cell {
            -moz-appearance: textfield;
        }
        
        .summary-section {
            padding: 20px 32px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            display: none;
        }
        .summary-section.show {
            display: block;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: #fff;
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid #6366f1;
            box-shadow: 0 2px 8px rgba(60,72,100,0.04);
        }
        
        .summary-card h4 {
            color: #6366f1;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .summary-card .value {
            color: #374151;
            font-size: 1.5rem;
            font-weight: 800;
        }
        
        .summary-card .description {
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 4px;
        }
        
        .footer {
            background: #6366f1;
            color: #fff;
            padding: 18px 32px;
            text-align: center;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            font-size: 1rem;
            letter-spacing: 0.2px;
        }
        .loading {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(60,72,100,0.18);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .loading.show {display:flex;}

        /* NUEVO: Toast de escaneo */
        .scan-toast { position: fixed; right: 18px; bottom: 18px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 8px 32px rgba(17,24,39,.35); opacity:0; transform: translateY(10px); transition: all .25s; z-index: 5000; font-weight:700; }
        .scan-toast.show { opacity:1; transform: translateY(0); }

        /* NUEVO: Modal configuración de escáner */
        .scanner-modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:4000; }
        .scanner-modal { width: min(680px, 92vw); background:#fff; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,.25); overflow:hidden; }
        .scanner-modal header { background:#6366f1; color:#fff; padding:14px 16px; font-weight:800; letter-spacing:.3px; display:flex; align-items:center; justify-content:space-between; }
        .scanner-modal .content { padding:16px; }
        .scanner-modal .row { display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
        .scanner-modal input { padding:7px 10px; border:1.5px solid #e5e7eb; border-radius:8px; flex:1; min-width:140px; }
        .scanner-modal table { width:100%; border-collapse: collapse; margin-top:8px; }
        .scanner-modal th, .scanner-modal td { border-bottom:1px solid #f3f4f6; padding:8px; text-align:left; }
        .scanner-modal .actions { display:flex; gap:10px; justify-content:flex-end; padding:12px 16px 16px 16px; }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: #374151;
        }
        .empty-state p {
            font-size: 1rem;
            margin-bottom: 24px;
        }
        
        @media (max-width:900px) {
            .container {margin: 10px;}
            .header {padding: 24px 12px 18px 12px;}
            .upload-section, .search-container, .table-container, .data-analysis-section, .summary-section {padding-left: 10px; padding-right: 10px;}
            .table-container {margin: 0 10px 18px 10px;}
            .columns-grid {grid-template-columns: 1fr;}
            .search-grid {grid-template-columns: 1fr; gap: 8px;}
        }
        @media (max-width:600px) {
            .header {
                flex-direction: row;
                justify-content: center;
                gap: 0;
                padding: 18px 6px 12px 6px;
            }
            .header .menu-hamburguesa {
                margin: 0;
                position: absolute;
                left: 8px;
                top: 8px;
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
                background: rgba(255,255,255,0.18);
            }
            .header-content {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-left: 0;
            }
            .header h1 {
                font-size: 1.4rem;
                justify-content: center;
            }
            .side-menu {
                width: 65vw;
                min-width: 120px;
                max-width: 220px;
                left: -65vw;
                border-radius: 0 0 14px 0;
                padding-top: 40px;
            }
            .side-menu.open {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Menú lateral -->
    <nav class="side-menu" id="sideMenu">
        <button class="close-btn" onclick="cerrarMenuLateral()" title="Cerrar menú">&times;</button>
        <div class="menu-title">Menú</div>
        <ul>
            <!-- Reemplazado Inventario General por Inventario Diario -->
            <li><a href="index.html" onclick="cerrarMenuLateral()">Inventario Diario</a></li>
            <li><a href="historicos.html" onclick="cerrarMenuLateral()">Históricos</a></li>
        </ul>
    </nav>
    
    <div class="container">
        <div class="header">
            <button class="menu-hamburguesa" onclick="abrirMenuLateral()" title="Menú" aria-label="Abrir menú">
                <span></span>
            </button>
            <div class="header-content">
                <h1><span class="icon">📦</span> Inventario con lotes</h1>
                <p>Extrae, analiza y procesa datos de Excel - Omnilife</p>
                <!-- Eliminar los controles de escaneo de aquí -->
            </div>
        </div>
        
        <div class="upload-section">
            <!-- NUEVO: Campo de fecha para guardar por día -->
            <div style="margin-bottom: 18px; text-align: center;">
                <label for="fechaInventario" style="font-weight:600;color:#6366f1;margin-right:8px;">Fecha del Inventario:</label>
                <input type="date" id="fechaInventario" style="padding:7px 14px;border-radius:7px;border:1.5px solid #e5e7eb;">
            </div>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon" id="uploadIcon">📁</div>
                <div class="upload-text" id="uploadText">Selecciona un archivo Excel</div>
                <div class="upload-subtext" id="uploadSubtext">Arrastra y suelta aquí o haz clic para seleccionar (.xlsx, .xls)</div>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" onchange="manejarArchivoSeleccionado(event)">
            <div class="controls"></div>
            <div class="action-toolbar" style="flex-direction: column; gap: 16px;">
                <!-- Primera fila: Botones principales -->
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; width: 100%;">
                    <button class="btn btn-info" id="analyzeBtn" onclick="analizarDatos()" disabled>
                        🔍 Analizar Datos
                    </button>
                    <button class="btn btn-success" id="exportBtn" onclick="exportarExcel()" disabled>
                        📑 Exportar Excel
                    </button>
                    <button class="btn btn-primary" id="saveBtn" onclick="guardarEnBaseDatos()" disabled>
                        💾 Guardar en Base de Datos
                    </button>
                    <button class="btn btn-warning" id="clearBtn" onclick="limpiarDatos()" disabled>
                        🔄 Limpiar Todo
                    </button>
                </div>
                
                <!-- Segunda fila: Controles de escaneo -->
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center; width: 100%; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                    <button class="btn btn-secondary" id="toggleScanBtn" style="background:#22c55e;color:#fff;" title="Activar/Desactivar lectura de pistola">&#128424; Escaneo: ON</button>
                    <button class="btn btn-secondary" id="configScanBtn" style="background:#60a5fa;color:#fff;" title="Configurar multipacks / equivalencias">&#9881; Config Escáner</button>
                    <label for="scanTargetSelect" style="font-weight:600;color:#374151;">Columna destino:</label>
                    <select id="scanTargetSelect" class="filter-select" style="min-width: 160px;">
                        <option value="AUTO">Auto (según foco)</option>
                        <option value="FISICO">FISICO</option>
                        <option value="DISPLAY">DISPLAY</option>
                        <option value="MERMA">MERMA</option>
                    </select>
                </div>
            </div>
            
            <!-- Selector de hoja (agregado dinámicamente) -->
            <div id="sheetSelectorDiv" style="margin: 16px 0; display: none;">
                <label for="sheetSelector" style="font-weight:600;color:#6366f1;margin-right:8px;">Selecciona la hoja:</label>
                <select id="sheetSelector" style="padding:6px 12px;border-radius:6px;border:1.5px solid #e5e7eb;"></select>
                <button class="btn btn-info" id="loadSheetBtn" style="margin-left:10px;">Cargar Hoja</button>
            </div>
        </div>
        
        <!-- Sección de análisis de datos -->
        <div class="data-analysis-section" id="dataAnalysisSection">
            <h3 style="color: #6366f1; margin-bottom: 16px; font-size: 1.2rem;">📋 Análisis de Columnas</h3>
            <div class="columns-grid" id="columnsGrid">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
        
        <!-- Sección de resumen -->
        <div class="summary-section" id="summarySection">
            <h3 style="color: #6366f1; margin-bottom: 16px; font-size: 1.2rem;">📈 Resumen de Datos</h3>
            <div class="summary-grid" id="summaryGrid">
                <!-- Se llenará dinámicamente -->
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-info" onclick="extraerValoresEspecificos()">
                    🎯 Extraer Valores Específicos
                </button>
                <button class="btn btn-primary" onclick="generarReporte()">
                    📊 Generar Reporte Completo
                </button>
            </div>
        </div>
        
        <div class="search-container" id="searchContainer">
            <div class="search-grid">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Buscar en todas las columnas...">
                    <span class="search-icon">🔍</span>
                </div>
                <select id="columnFilter" class="filter-select">
                    <option value="">Todas las columnas</option>
                </select>
                <button class="btn btn-primary" onclick="aplicarFiltros()">
                    🔍 Filtrar
                </button>
            </div>
        </div>
        
        <div class="table-container" id="tableContainer">
            <table class="dynamic-table" id="dynamicTable">
                <thead id="tableHead">
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <!-- NUEVO: Modal de configuración del escáner -->
        <div class="scanner-modal-overlay" id="scannerConfigOverlay" role="dialog" aria-modal="true">
            <div class="scanner-modal" role="document">
                <header>
                    <div>Configuración de Escáner / Multipacks</div>
                    <button class="btn" style="background:rgba(255,255,255,.15);border:none;color:#fff;" onclick="cerrarConfigEscaner()">&#10005;</button>
                </header>
                <div class="content">
                    <div style="color:#374151; margin-bottom:10px;">
                        - Define equivalencias para cajas u otros códigos. Un escaneo del código externo sumará las <b>unidades</b> al material objetivo.<br>
                        - Si no existe mapeo para un código, se intentará usarlo como <b>Material</b> directamente.
                    </div>
                    
                    <!-- Multiplicador global -->
                    <div class="row" style="margin-bottom:10px;align-items:center;gap:8px;">
                        <label for="scanMultiplier" style="min-width:180px;color:#374151;">Multiplicador de códigos:</label>
                        <input id="scanMultiplier" type="number" min="1" step="1" value="1" placeholder="Unidades por escaneo" />
                        <button class="btn btn-secondary" onclick="guardarMultiplicadorEscaner()">Guardar</button>
                        <small style="color:#6b7280;">Aplica a todos los códigos</small>
                    </div>
                    
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="cerrarConfigEscaner()">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- NUEVO: Toast de escaneo -->
        <div id="scanToast" class="scan-toast" aria-live="polite"></div>

        <div class="empty-state" id="emptyState">
            <div class="icon">📊</div>
            <h3>No hay datos cargados</h3>
            <p>Selecciona un archivo Excel para extraer y analizar los valores de cada campo</p>
        </div>
        
        <div class="footer">
            <p>&copy; 2025 Procesador de Datos Excel - Omnilife. Todos los derechos reservados.</p>
        </div>
    </div>
    
    <script>
        // Variables globales para manejar los datos extraídos
        let excelData = [];
        let columnNames = [];
        let fileName = '';
        let columnAnalysis = {};
        let dataValues = {};
        let workbookGlobal = null;
        let sheetNamesGlobal = [];

        // ============ Escaneo por pistola (HID) ============
        let escaneoActivo = true; // toggle
        let bufferEscaneo = '';
        let timerEscaneo = null;
        let ultimoTiempoTecla = 0;
        let mapaEscaner = {}; // { codigoExterno: { material: '...', unidades: N } }
        let audioCtx = null;

        function cargarMapaEscaner() {
            try { mapaEscaner = JSON.parse(localStorage.getItem('barcodeMap') || '{}') || {}; }
            catch { mapaEscaner = {}; }
        }
        function guardarMapaEscaner() {
            localStorage.setItem('barcodeMap', JSON.stringify(mapaEscaner));
        }
        function guardarMultiplicadorEscaner() {
            try {
                const el = document.getElementById('scanMultiplier');
                const val = Math.max(1, parseInt((el && el.value) ? el.value : '1', 10));
                localStorage.setItem('scanMultiplier', String(val));
                toastScan(`Multiplicador global guardado: x${val}`);
            } catch {}
        }
        function beep(freq = 880, dur = 60) {
            try {
                audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.frequency.value = freq; o.type = 'square';
                g.gain.value = 0.06;
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); setTimeout(()=>o.stop(), dur);
            } catch {}
        }
        function toastScan(text) {
            const el = document.getElementById('scanToast');
            if (!el) return;
            el.textContent = text;
            el.classList.add('show');
            setTimeout(()=> el.classList.remove('show'), 1400);
        }
        function toggleEscaneo() {
            escaneoActivo = !escaneoActivo;
            const btn = document.getElementById('toggleScanBtn');
            if (btn) btn.innerHTML = escaneoActivo ? '&#128424; Escaneo: ON' : '&#128424; Escaneo: OFF';
            toastScan(escaneoActivo ? 'Escaneo activado' : 'Escaneo desactivado');
            // Si se apaga el escaneo, limpiar buffers y timers para evitar disparos pendientes
            if (!escaneoActivo) {
                try { clearTimeout(timerEscaneo); } catch {}
                timerEscaneo = null;
                bufferEscaneo = '';
            }
        }
        function abrirConfigEscaner() {
            cargarMapaEscaner();
            // Cargar multiplicador global en el input del modal
            const multInput = document.getElementById('scanMultiplier');
            if (multInput) {
                let mult = parseInt(localStorage.getItem('scanMultiplier') || '1', 10);
                if (!Number.isFinite(mult) || mult < 1) mult = 1;
                multInput.value = String(mult);
            }
            const tbody = document.getElementById('scannerMapTable');
            if (tbody) {
                tbody.innerHTML = '';
                Object.keys(mapaEscaner).forEach(code => {
                    const { material, unidades } = mapaEscaner[code] || {};
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${code}</td><td>${material||''}</td><td>${unidades||1}</td><td><button class="btn" style="background:#fee2e2;color:#991b1b;" onclick="eliminarEquivalenciaEscaner('${code.replace(/'/g,"&#39;")}')">Eliminar</button></td>`;
                    tbody.appendChild(tr);
                });
            }
            document.getElementById('scannerConfigOverlay').style.display = 'flex';
        }
        function cerrarConfigEscaner() {
            document.getElementById('scannerConfigOverlay').style.display = 'none';
        }
        function agregarEquivalenciaEscaner() {
            const code = (document.getElementById('mapBarcode').value||'').trim();
            let material = (document.getElementById('mapMaterial').value||'').trim();
            const unidades = Math.max(1, parseInt(document.getElementById('mapUnits').value||'1',10));
            if (!code) { alert('Ingresa un código externo'); return; }
            if (!material) material = '';
            mapaEscaner[code] = { material: material || undefined, unidades };
            guardarMapaEscaner();
            abrirConfigEscaner(); // recargar tabla
            document.getElementById('mapBarcode').value = '';
            document.getElementById('mapMaterial').value = '';
            document.getElementById('mapUnits').value = '1';
        }
        function eliminarEquivalenciaEscaner(code) {
            delete mapaEscaner[code];
            guardarMapaEscaner();
            abrirConfigEscaner();
        }
        function limpiarEquivalenciasEscaner() {
            if (confirm('¿Borrar todas las equivalencias de escáner?')) {
                mapaEscaner = {};
                guardarMapaEscaner();
                abrirConfigEscaner();
            }
        }
        function esCaracterImprimible(e) {
            if (e.key.length === 1) return true;
            const especiales = ['Slash','Backslash','Minus','Period','Comma'];
            return especiales.includes(e.code);
        }
        function procesarLecturaEscaner(cadena) {
            // Seguridad: no procesar si el escaneo está desactivado
            if (!escaneoActivo) return;
            if (!cadena) return;
            
            // NUEVO: Limpiar el código escaneado de caracteres no deseados
            cadena = cadena.replace(/[\r\n\t\x00-\x1F\x7F]/g, '').trim();
            console.log('Código limpiado:', cadena);
            
            // 1) Resolver equivalencia
            cargarMapaEscaner();
            let objetivoMaterial = null;
            let unidades = 1;
            if (mapaEscaner[cadena]) {
                objetivoMaterial = mapaEscaner[cadena].material || null;
                unidades = mapaEscaner[cadena].unidades || 1;
            }
            // 2) Ubicar columnas relevantes
            const materialCol = columnNames.find(c => (c||'').trim().toUpperCase().includes('MATERIAL'));
            const fisicoCol = columnNames.find(c => (c||'').trim().toUpperCase().includes('FISICO') || (c||'').trim().toUpperCase().includes('FÍSICO'));
            const displayCol = columnNames.find(c => (c||'').trim().toUpperCase().includes('DISPLAY'));
            const mermaCol = columnNames.find(c => (c||'').trim().toUpperCase().includes('MERMA'));
            const sapCol = columnNames.find(c => (c||'').trim().toUpperCase().includes('SAP'));
            const diferenciaCol = columnNames.find(c => (c||'').trim().toUpperCase().includes('DIFERENCIA'));
            if (!materialCol || !fisicoCol) { toastScan('No se detectó columna MATERIAL/FISICO'); return; }
            // 3) Determinar material a buscar (con búsqueda parcial mejorada)
            const materialBuscado = (objetivoMaterial || cadena).trim();
            
            // Primero buscar coincidencia exacta
            let idx = excelData.findIndex(row => String(row[materialCol] ?? '').trim() === materialBuscado);
            
            // Si no encuentra coincidencia exacta, buscar si el código escaneado está contenido en algún material
            if (idx === -1) {
                idx = excelData.findIndex(row => {
                    const materialCompleto = String(row[materialCol] ?? '').trim();
                    // Buscar si el código escaneado está contenido en el material completo
                    return materialCompleto.includes(materialBuscado);
                });
            }
            
            // Si aún no encuentra, buscar sin considerar prefijos/sufijos comunes
            if (idx === -1) {
                idx = excelData.findIndex(row => {
                    const materialCompleto = String(row[materialCol] ?? '').trim();
                    // Extraer la parte numérica del material completo (ej: de "801122200ES" extraer "1122200")
                    const numeroMaterial = materialCompleto.replace(/^[0-9]*([0-9]{7})[A-Z]*$/i, '$1');
                    return numeroMaterial === materialBuscado || materialCompleto.endsWith(materialBuscado);
                });
            }
            
            if (idx === -1) { 
                toastScan(`Código no encontrado: ${materialBuscado}`); 
                beep(220,120); 
                return; 
            }
            // 4) Determinar columna objetivo (selector o foco)
            let colObjetivo = null;
            const sel = document.getElementById('scanTargetSelect');
            const prefer = sel ? (sel.value || 'AUTO').toUpperCase() : 'AUTO';
            const preferMap = { FISICO: fisicoCol, DISPLAY: displayCol, MERMA: mermaCol };
            if (prefer !== 'AUTO') {
                colObjetivo = preferMap[prefer] || fisicoCol || displayCol || mermaCol;
            } else {
                const ae = document.activeElement;
                if (ae && ae.tagName === 'INPUT' && ae.classList.contains('editable-cell')) {
                    colObjetivo = ae.getAttribute('data-col-key');
                }
                if (![fisicoCol, displayCol, mermaCol].includes(colObjetivo)) {
                    colObjetivo = fisicoCol || displayCol || mermaCol;
                }
            }
            // 5) Sumar unidades en la columna elegida (unidades del mapeo x multiplicador global)
            const actual = Number(excelData[idx][colObjetivo]) || 0;
            const multiplicadorGlobal = Math.max(1, parseInt(localStorage.getItem('scanMultiplier') || '1', 10));
            const base = Number(unidades) > 0 ? Number(unidades) : 1;
            const incremento = base * multiplicadorGlobal;
            const nuevo = actual + incremento;
            excelData[idx][colObjetivo] = nuevo;
            
            // DEBUG: Log para verificar el comportamiento
            console.log('=== ESCANEO DEBUG ===');
            console.log('Material encontrado:', excelData[idx][materialCol]);
            console.log('Columna objetivo:', colObjetivo);
            console.log('Valor actual:', actual);
            console.log('Incremento aplicado:', incremento);
            console.log('Valor nuevo:', nuevo);
            console.log('====================');
            // Actualizar input visible de esa fila/columna si existe
            const targetInput = document.querySelector(`input.editable-cell[data-row-index="${idx}"][data-col-key="${colObjetivo}"]`);
            if (targetInput) { 
                console.log('Actualizando input, valor anterior:', targetInput.value, 'nuevo valor:', nuevo);
                targetInput.value = String(nuevo);
                // Disparar evento para actualizar todos los cálculos
                targetInput.dispatchEvent(new Event('input', { bubbles: true }));
            } else {
                console.log('No se encontró el input para actualizar. Índice:', idx, 'Columna:', colObjetivo);
                // Buscar input alternativo sin restricción de fila específica
                const allInputs = document.querySelectorAll(`input.editable-cell[data-col-key="${colObjetivo}"]`);
                console.log('Inputs encontrados para la columna:', allInputs.length);
                if (allInputs[idx]) {
                    console.log('Actualizando input alternativo, valor:', nuevo);
                    allInputs[idx].value = String(nuevo);
                    allInputs[idx].dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
            // Si es DISPLAY, también actualizar el arreglo personalizado
            if (colObjetivo === displayCol && typeof cargarDisplayPersonalizados === 'function' && typeof guardarDisplayPersonalizados === 'function') {
                try {
                    const arr = cargarDisplayPersonalizados(excelData.length) || [];
                    arr[idx] = nuevo;
                    guardarDisplayPersonalizados(arr);
                } catch {}
            }
            // 6) Recalcular diferencia si procede
            if (diferenciaCol) {
                const fis = Number(excelData[idx][fisicoCol]) || 0;
                const disp = displayCol ? (Number(excelData[idx][displayCol]) || 0) : 0;
                const mer = mermaCol ? (Number(excelData[idx][mermaCol]) || 0) : 0;
                const sap = sapCol ? (Number(excelData[idx][sapCol]) || 0) : 0;
                excelData[idx][diferenciaCol] = fis + disp + mer - sap;
            }
            // 7) Feedback
            const mat = excelData[idx][materialCol];
            const etiqueta = (colObjetivo === fisicoCol ? 'FISICO' : colObjetivo === displayCol ? 'DISPLAY' : 'MERMA');
            toastScan(`+${incremento} a ${etiqueta} del Material ${mat} (= ${nuevo})`);
            beep(880, 80);
            // 8) Persistir si aplica
            try { guardarDatosLocalmente && guardarDatosLocalmente(); } catch {}
        }
        function inicializarEscaneo() {
            cargarMapaEscaner();
            const btnToggle = document.getElementById('toggleScanBtn');
            if (btnToggle) btnToggle.addEventListener('click', toggleEscaneo);
            const btnCfg = document.getElementById('configScanBtn');
            if (btnCfg) btnCfg.addEventListener('click', abrirConfigEscaner);
            window.addEventListener('keydown', (e) => {
                if (!escaneoActivo) return;
                const ahora = Date.now();
                const delta = ahora - (ultimoTiempoTecla || 0);
                if (delta > 80) bufferEscaneo = '';
                ultimoTiempoTecla = ahora;
                if (e.key === 'Enter' || e.key === 'Tab') {
                    const lectura = bufferEscaneo.trim();
                    bufferEscaneo = '';
                    if (lectura.length >= 4) {
                        e.preventDefault();
                        procesarLecturaEscaner(lectura);
                    }
                    return;
                }
                // Evitar que las teclas del escáner escriban en inputs
                if (e.key && e.key.length === 1) {
                    e.preventDefault();
                    e.stopPropagation();
                    bufferEscaneo += e.key;
                    console.log('Carácter agregado:', e.key, 'Buffer actual:', bufferEscaneo);
                }
                clearTimeout(timerEscaneo);
                timerEscaneo = setTimeout(() => {
                    const lectura = bufferEscaneo.trim();
                    bufferEscaneo = '';
                    if (lectura.length >= 6) procesarLecturaEscaner(lectura);
                }, 120);
            }, true);
        }

        // Configuración Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC0i3Btw_EhcRB-gwocAA3mHKQc2foE86w",
            authDomain: "inventario-cedis-64eef.firebaseapp.com",
            projectId: "inventario-cedis-64eef",
            storageBucket: "inventario-cedis-64eef.appspot.com",
            messagingSenderId: "730229452536",
            appId: "1:730229452536:web:cb011c50d795253037150d",
            measurementId: "G-G3X02X14X9"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        
        // Menú lateral
        function abrirMenuLateral() {
            document.getElementById('sideMenu').classList.add('open');
        }
        
        function cerrarMenuLateral() {
            document.getElementById('sideMenu').classList.remove('open');
        }
        
        // Cerrar menú al hacer clic fuera
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('sideMenu');
            const burger = document.querySelector('.menu-hamburguesa');
            if (menu.classList.contains('open') && !menu.contains(e.target) && !burger.contains(e.target)) {
                cerrarMenuLateral();
            }
        });
        
        // Drag and drop
        const uploadZone = document.getElementById('uploadZone');
        
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                procesarArchivo(files[0]);
            }
        });
        
        // Manejar archivo seleccionado
        function manejarArchivoSeleccionado(event) {
            const file = event.target.files[0];
            if (file) {
                procesarArchivo(file);
            }
        }

        // Leer workbook y preparar selector de hoja
        function procesarArchivo(file) {
            showLoading(true);
            fileName = (file?.name || '').replace(/\.[^.]+$/, '') || 'Inventario';
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    workbookGlobal = wb;
                    sheetNamesGlobal = wb.SheetNames || [];
                    if (!sheetNamesGlobal.length) {
                        alert('No se encontraron hojas en el archivo');
                        showLoading(false);
                        return;
                    }
                    mostrarSelectorDeHojaDesplegable();
                } catch (err) {
                    console.error(err);
                    alert('Error leyendo el archivo Excel');
                } finally {
                    showLoading(false);
                }
            };
            reader.onerror = function () {
                alert('No se pudo leer el archivo');
                showLoading(false);
            };
            reader.readAsArrayBuffer(file);
        }
        // Construir y mostrar el selector desplegable
        function mostrarSelectorDeHojaDesplegable() {
            const div = document.getElementById('sheetSelectorDiv');
            const sel = document.getElementById('sheetSelector');
            const btn = document.getElementById('loadSheetBtn');
            if (!div || !sel || !btn) return;
            sel.innerHTML = '';
            sheetNamesGlobal.forEach((name, i) => {
                const opt = document.createElement('option');
                opt.value = name; opt.textContent = `${i+1}. ${name}`;
                sel.appendChild(opt);
            });
            div.style.display = 'block';
            btn.onclick = function(){
                const chosen = sel.value;
                if (!chosen) { alert('Selecciona una hoja'); return; }
                procesarHojaExcel(chosen);
                // ocultar selector luego de cargar
                div.style.display = 'none';
            };
        }
        // Convertir hoja seleccionada a json y preparar UI
        function procesarHojaExcel(sheetName) {
            if (!workbookGlobal || !sheetName) { alert('Workbook u hoja no disponible'); return; }
            showLoading(true);
            try {
                const ws = workbookGlobal.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(ws, { defval: '', raw: false });
                excelData = json;
                // obtener encabezados
                const range = XLSX.utils.decode_range(ws['!ref']);
                const headers = [];
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddr = XLSX.utils.encode_cell({ r: range.s.r, c: C });
                    const cell = ws[cellAddr];
                    let hdr = cell && cell.v ? String(cell.v).trim() : `COL_${C}`;
                    headers.push(hdr);
                }
                columnNames = headers;
                // habilitar UI
                document.getElementById('analyzeBtn')?.removeAttribute('disabled');
                document.getElementById('exportBtn')?.removeAttribute('disabled');
                document.getElementById('saveBtn')?.removeAttribute('disabled');
                document.getElementById('clearBtn')?.removeAttribute('disabled');
                // mostrar secciones
                document.getElementById('searchContainer')?.classList.add('show');
                document.getElementById('tableContainer')?.classList.add('show');
                document.getElementById('emptyState')?.remove();
                actualizarFiltroColumnas();
                renderizarTabla('', '');
                // preparar selector columna destino escáner
                const sel = document.getElementById('scanTargetSelect');
                if (sel) {
                    sel.innerHTML = '';
                    const optAuto = document.createElement('option'); optAuto.value='AUTO'; optAuto.textContent='AUTO'; sel.appendChild(optAuto);
                    ['REAL','FISICO','DISPLAY','MERMA'].forEach(k=>{
                        const exists = columnNames.find(c => (c||'').toUpperCase().includes(k));
                        if (exists) { const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); }
                    });
                }
                guardarDatosLocalmente();
            } catch (err) {
                console.error(err);
                alert('Error procesando la hoja seleccionada');
            } finally {
                showLoading(false);
            }
        }

        // Columnas ocultas en la vista (pero presentes para cálculos y exportación)
        function esColumnaOculta(nombre) {
            const u = (nombre || '').trim().toUpperCase();
            return u === 'SAP' || u === 'DIFERENCIA' || u === 'DIFERENCIAS';
        }
        function obtenerColumnasVisibles() {
            return (columnNames || []).filter(c => !esColumnaOculta(c));
        }

        // Actualiza el filtro de columnas (ocultando SAP/DIFERENCIA)
        function actualizarFiltroColumnas() {
            const select = document.getElementById('columnFilter');
            if (!select) return;
            select.innerHTML = '<option value="">Todas las columnas</option>';
            obtenerColumnasVisibles().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        // Render de tabla mostrando solo columnas visibles
        function renderizarTabla(filtro = '', columna = '') {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            if (!thead || !tbody) return;
            thead.innerHTML = '';
            tbody.innerHTML = '';
            if (!excelData.length || !columnNames.length) return;
            const visibles = obtenerColumnasVisibles();
            const trh = document.createElement('tr');
            visibles.forEach(h => { const th=document.createElement('th'); th.textContent = h; trh.appendChild(th); });
            thead.appendChild(trh);
            const rows = excelData.filter(row => {
                if (!filtro) return true;
                if (columna) return String(row[columna] ?? '').toLowerCase().includes(filtro.toLowerCase());
                // búsqueda solo en columnas visibles
                return visibles.some(c => String(row[c] ?? '').toLowerCase().includes(filtro.toLowerCase()));
            });
            rows.slice(0, 500).forEach((row) => {
                const tr = document.createElement('tr');
                visibles.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = row[col] ?? '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // Hook input/selector existentes
        document.getElementById('searchInput')?.addEventListener('input', function(){
            const selectedColumn = document.getElementById('columnFilter')?.value || '';
            renderizarTabla(this.value, selectedColumn);
        });
        document.getElementById('columnFilter')?.addEventListener('change', function(){
            const searchTerm = document.getElementById('searchInput')?.value || '';
            renderizarTabla(searchTerm, this.value);
        });

        // Persistencia ligera
        function guardarDatosLocalmente() {
            try {
                const payload = { excelData, columnNames, fileName };
                localStorage.setItem('importadorDinamicoData', JSON.stringify(payload));
            } catch {}
        }
        function cargarDatosLocalmente() {
            try {
                const saved = JSON.parse(localStorage.getItem('importadorDinamicoData') || 'null');
                if (saved && saved.excelData && saved.columnNames) {
                    excelData = saved.excelData; columnNames = saved.columnNames; fileName = saved.fileName || 'Inventario';
                    document.getElementById('analyzeBtn')?.removeAttribute('disabled');
                    document.getElementById('exportBtn')?.removeAttribute('disabled');
                    document.getElementById('saveBtn')?.removeAttribute('disabled');
                    document.getElementById('clearBtn')?.removeAttribute('disabled');
                    document.getElementById('searchContainer')?.classList.add('show');
                    document.getElementById('tableContainer')?.classList.add('show');
                    actualizarFiltroColumnas();
                    renderizarTabla('', '');
                }
            } catch {}
        }

        window.onload = function() {
            cargarDatosLocalmente();
        };
        // Función para guardar en la base de datos
        function guardarEnBaseDatos() {
            const fechaInventario = document.getElementById('fechaInventario').value;
            
            if (!fechaInventario) {
                alert('Por favor selecciona una fecha para el inventario');
                return;
            }
            
            if (!excelData || excelData.length === 0) {
                alert('No hay datos para guardar. Por favor carga un archivo Excel primero.');
                return;
            }
            
            if (confirm(`¿Confirmas guardar el inventario del ${fechaInventario} en la base de datos?`)) {
                showLoading(true);
                
                // Preparar los datos para guardar
                const datosParaGuardar = {
                    fecha: fechaInventario,
                    fechaCreacion: firebase.firestore.Timestamp.now(),
                    nombreArchivo: fileName,
                    totalRegistros: excelData.length,
                    columnas: columnNames,
                    datos: excelData,
                    resumen: {
                        totalProductos: excelData.length,
                        columnasAnalizadas: Object.keys(columnAnalysis).length
                    }
                };
                
                // Guardar en Firestore usando la fecha como ID del documento
                // CAMBIO: usar la colección 'inventario_por_lotes' en lugar de 'inventario_diario'
                db.collection('inventario_por_lotes').doc(fechaInventario).set(datosParaGuardar)
                    .then(() => {
                        showLoading(false);
                        alert('Datos guardados exitosamente en la base de datos');
                        console.log('Documento guardado con ID:', fechaInventario);
                    })
                    .catch((error) => {
                        showLoading(false);
                        alert('Error al guardar en la base de datos: ' + error.message);
                        console.error('Error:', error);
                    });
            }
        }
        
        // Función para analizar datos
        function analizarDatos() {
            if (!excelData || excelData.length === 0) {
                alert('No hay datos para analizar');
                return;
            }
            
            showLoading(true);
            
            // Mostrar análisis de columnas
            mostrarAnalisisColumnas();
            
            // Mostrar resumen
            mostrarResumen();
            
            // Mostrar las secciones
            document.getElementById('dataAnalysisSection').classList.add('show');
            document.getElementById('summarySection').classList.add('show');
            
            showLoading(false);
        }
        
        // Mostrar análisis de columnas
        function mostrarAnalisisColumnas() {
            const grid = document.getElementById('columnsGrid');
            grid.innerHTML = '';
            
            columnNames.forEach(columnName => {
                const analysis = columnAnalysis[columnName];
                if (!analysis) return;
                
                const card = document.createElement('div');
                card.className = 'column-card';
                
                card.innerHTML = `
                    <div class="column-header">
                        <div class="column-name">${columnName}</div>
                        <div class="column-type">${analysis.type}</div>
                    </div>
                    <div class="column-stats">
                        Total: ${analysis.totalValues} | Únicos: ${analysis.uniqueCount} | Vacíos: ${analysis.emptyCount}
                    </div>
                    ${analysis.estadisticas ? `
                        <div class="column-stats">
                            Min: ${analysis.estadisticas.min} | Max: ${analysis.estadisticas.max} | Promedio: ${analysis.estadisticas.promedio.toFixed(2)}
                        </div>
                    ` : ''}
                    <div class="unique-values">
                        ${analysis.sampleValues.map(val => `<span class="value-item">${val}</span>`).join('')}
                        ${analysis.uniqueCount > 10 ? `<span class="value-item">...y ${analysis.uniqueCount - 10} más</span>` : ''}
                    </div>
                    <div style="margin-top: 8px;">
                        <button class="btn btn-info" style="font-size: 0.8rem; padding: 4px 8px;" onclick="extraerValoresColumna('${columnName}')">
                            Ver todos
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Mostrar resumen de datos
        function mostrarResumen() {
            const grid = document.getElementById('summaryGrid');
            grid.innerHTML = '';
            
            // Total de registros
            const totalCard = document.createElement('div');
            totalCard.className = 'summary-card';
            totalCard.innerHTML = `
                <h4>Total Registros</h4>
                <div class="value">${excelData.length}</div>
                <div class="description">Filas procesadas</div>
            `;
            grid.appendChild(totalCard);
            
            // Total de columnas
            const columnsCard = document.createElement('div');
            columnsCard.className = 'summary-card';
            columnsCard.innerHTML = `
                <h4>Columnas</h4>
                <div class="value">${columnNames.length}</div>
                <div class="description">Campos detectados</div>
            `;
            grid.appendChild(columnsCard);
            
            // Registros con datos válidos
            const centroColumn = columnNames.find(col => col.toUpperCase().includes('CENTRO'));
            let validRecords = excelData.length;
            if (centroColumn) {
                validRecords = excelData.filter(row => {
                    const centroValue = row[centroColumn];
                    return centroValue && centroValue.toString().trim() !== '' && centroValue.toString().trim() !== '0';
                }).length;
            }
            
            const validCard = document.createElement('div');
            validCard.className = 'summary-card';
            validCard.innerHTML = `
                <h4>Registros Válidos</h4>
                <div class="value">${validRecords}</div>
                <div class="description">Con datos completos</div>
            `;
            grid.appendChild(validCard);
            
            // Resumen de tipos de datos
            const tipos = {};
            Object.values(columnAnalysis).forEach(analysis => {
                tipos[analysis.type] = (tipos[analysis.type] || 0) + 1;
            });
            
            Object.entries(tipos).forEach(([tipo, cantidad]) => {
                const tipoCard = document.createElement('div');
                tipoCard.className = 'summary-card';
                tipoCard.innerHTML = `
                    <h4>Columnas ${tipo}</h4>
                    <div class="value">${cantidad}</div>
                    <div class="description">Tipo de dato</div>
                `;
                grid.appendChild(tipoCard);
            });
        }
        
        // Función para exportar Excel
        function exportarExcel() {
            if (!excelData || excelData.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            
            showLoading(true);
            
            try {
                // Crear un nuevo workbook
                const wb = XLSX.utils.book_new();
                
                // INCLUIR TODAS LAS COLUMNAS en el export (SAP y DIFERENCIAS)
                const columnasParaExportar = columnNames;
                
                // Preparar datos con TODAS las columnas
                const datosParaExportar = excelData.map(row => {
                    const nuevaFila = {};
                    columnasParaExportar.forEach(col => {
                        nuevaFila[col] = row[col];
                    });
                    return nuevaFila;
                });
                
                // Crear hoja de datos procesados
                const ws = XLSX.utils.json_to_sheet(datosParaExportar);
                XLSX.utils.book_append_sheet(wb, ws, 'Datos Procesados');
                
                // Crear hoja de resumen
                const resumenData = [
                    ['Archivo Original', fileName],
                    ['Fecha de Procesamiento', new Date().toLocaleString()],
                    ['Total de Registros', excelData.length],
                    ['Columnas Procesadas', columnasParaExportar.length],
                    [''],
                    ['Análisis por Columna', ''],
                    ['Columna', 'Tipo', 'Valores Totales', 'Valores Únicos', 'Valores Vacíos']
                ];
                
                columnasParaExportar.forEach(col => {
                    const analysis = columnAnalysis[col];
                    if (analysis) {
                        resumenData.push([
                            col,
                            analysis.type,
                            analysis.totalValues,
                            analysis.uniqueCount,
                            analysis.emptyCount
                        ]);
                    }
                });
                
                const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
                XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');
                
                // Descargar archivo
                const fechaActual = new Date().toISOString().split('T')[0];
                const nombreArchivo = `${fileName}_procesado_${fechaActual}.xlsx`;
                XLSX.writeFile(wb, nombreArchivo);
                
                showLoading(false);
                alert('Archivo Excel exportado exitosamente');
            } catch (error) {
                showLoading(false);
                alert('Error al exportar Excel: ' + error.message);
                console.error('Error:', error);
            }
        }
        
        // Función para limpiar datos
        function limpiarDatos() {
            if (confirm('¿Estás seguro de que quieres limpiar todos los datos? Esta acción no se puede deshacer.')) {
                // Limpiar variables globales
                excelData = [];
                columnNames = [];
                fileName = '';
                columnAnalysis = {};
                dataValues = {};
                workbookGlobal = null;
                
                // Limpiar localStorage
                localStorage.removeItem('datosExcelActuales');
                localStorage.removeItem('displayPersonalizado');
                
                // Resetear interfaz
                const uploadIcon = document.getElementById('uploadIcon');
                const uploadText = document.getElementById('uploadText');
                const uploadSubtext = document.getElementById('uploadSubtext');
                const uploadZone = document.getElementById('uploadZone');
                
                uploadIcon.textContent = '📁';
                uploadText.textContent = 'Selecciona un archivo Excel';
                uploadSubtext.textContent = 'Arrastra y suelta aquí o haz clic para seleccionar (.xlsx, .xls)';
                uploadZone.classList.remove('has-file');
                
                // Deshabilitar controles
                document.getElementById('analyzeBtn').disabled = true;
                document.getElementById('exportBtn').disabled = true;
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('clearBtn').disabled = true;
                
                // Ocultar secciones
                document.getElementById('searchContainer').classList.remove('show');
                document.getElementById('tableContainer').classList.remove('show');
                document.getElementById('dataAnalysisSection').classList.remove('show');
                document.getElementById('summarySection').classList.remove('show');
                document.getElementById('emptyState').style.display = 'block';
                
                // Limpiar tabla
                document.getElementById('tableHead').innerHTML = '';
                document.getElementById('tableBody').innerHTML = '';
                
                // Limpiar grids
                document.getElementById('columnsGrid').innerHTML = '';
                document.getElementById('summaryGrid').innerHTML = '';
                
                // Resetear input de archivo
                document.getElementById('fileInput').value = '';
                document.getElementById('fechaInventario').value = '';
                
                alert('Datos limpiados exitosamente');
            }
        }
        // Utilidad: mostrar/ocultar overlay de carga (fallback si no existe)
        function showLoading(show) {
            const el = document.getElementById('loading');
            if (!el) return;
            el.classList.toggle('show', !!show);
        }
    </script>
<script>
(function() {
  function setText(sel, text) { const el = document.querySelector(sel); if (el) el.textContent = text; }
  function setHTML(sel, html) { const el = document.querySelector(sel); if (el) el.innerHTML = html; }
  window.addEventListener('load', function() {
    function fixText(s){
      return (s||'')
        .replaceAll('aqu�','aquí')
        .replaceAll('v�lido','válido')
        .replaceAll('vac�a','vacía')
        .replaceAll('vac�os','vacíos')
        .replaceAll('An�lisis','Análisis')
        .replaceAll('b�squeda','búsqueda')
        .replaceAll('No se encontr�','No se encontró')
        .replaceAll('Est�s','Estás')
        .replaceAll('acci�n','acción')
        .replaceAll('m�s','más')
        .replaceAll('Men�','Menú')
        .replaceAll('men�','menú')
        .replaceAll('Hist��ricos','Históricos');
    }
    // Normalizar alert/confirm
    if (typeof window.alert === 'function'){
      const _a = window.alert; window.alert = (m)=>_a(fixText(String(m)));
    }
    if (typeof window.confirm === 'function'){
      const _c = window.confirm; window.confirm = (m)=>_c(fixText(String(m)));
    }
    // Barrido de textos visibles con errores comunes
    (function sweep(){
      const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
      const nodes = [];
      while (walker.nextNode()) nodes.push(walker.currentNode);
      nodes.forEach(n=>{ const fixed = fixText(n.nodeValue); if (fixed !== n.nodeValue) n.nodeValue = fixed; });
    })();
    // Encabezado e íconos principales
    setText('.header h1 .icon', '📦');
    const closeBtn = document.querySelector('.side-menu .close-btn');
    if (closeBtn) closeBtn.setAttribute('title','Cerrar menú');
    setText('.side-menu .menu-title', 'Menú');
    // Zona de carga
    setText('#uploadIcon','📄');
    const upSub = document.getElementById('uploadSubtext');
    if (upSub) upSub.textContent = 'Arrastra y suelta aquí o haz clic para seleccionar (.xlsx, .xls)';
    // Botones principales
    setHTML('#analyzeBtn','🔍 Analizar Datos');
    setHTML('#exportBtn','📤 Exportar Excel');
    setHTML('#saveBtn','💾 Guardar en Base de Datos');
    setHTML('#clearBtn','🧹 Limpiar Todo');
    // Títulos de secciones
    const da = document.querySelector('#dataAnalysisSection h3'); if (da) da.textContent = '📊 Análisis de Columnas';
    const sum = document.querySelector('#summarySection h3'); if (sum) sum.textContent = '📋 Resumen de Datos';
    // Botones del resumen
    const extraBtn = Array.from(document.querySelectorAll('#summarySection .btn.btn-info')).find(b => (b.textContent || '').toLowerCase().includes('extraer') || (b.getAttribute('onclick')||'').includes('extraerValoresEspecificos'));
    if (extraBtn) extraBtn.textContent = '🎯 Extraer Valores Específicos';
    const repBtn = Array.from(document.querySelectorAll('#summarySection .btn.btn-primary')).find(b => (b.textContent || '').toLowerCase().includes('reporte') || (b.getAttribute('onclick')||'').includes('generarReporte'));
    if (repBtn) repBtn.textContent = '📈 Generar Reporte Completo';
    // Búsqueda
    setText('.search-icon','🔎');
    const filBtn = Array.from(document.querySelectorAll('.search-container .btn.btn-primary')).find(b => (b.textContent || '').trim().toLowerCase().includes('filtrar'));
    if (filBtn) filBtn.textContent = '🔍 Filtrar';
    // Estado vacío
    setText('#emptyState .icon','📄');
    // Tras cargar datos, ajustar icono y subtexto
    if (typeof window.actualizarInterfaz === 'function') {
      const originalActualizarInterfaz = window.actualizarInterfaz;
      window.actualizarInterfaz = function() {
        const r = originalActualizarInterfaz.apply(this, arguments);
        setText('#uploadIcon', '✅');
        const upSub2 = document.getElementById('uploadSubtext');
        if (upSub2) upSub2.textContent = `${excelData.length} filas, ${columnNames.length} columnas extraídas`;
        return r;
      };
    }
    // Al limpiar, restablecer textos
    if (typeof window.limpiarDatos === 'function') {
      const originalLimpiar = window.limpiarDatos;
      window.limpiarDatos = function() {
        const r = originalLimpiar.apply(this, arguments);
        setText('#uploadIcon', '📄');
        const upSub3 = document.getElementById('uploadSubtext');
        if (upSub3) upSub3.textContent = 'Arrastra y suelta aquí o haz clic para seleccionar (.xlsx, .xls)';
        return r;
      };
    }
    // Ajustar modal de valores de columna
    if (typeof window.extraerValoresColumna === 'function') {
      const orig = window.extraerValoresColumna;
      window.extraerValoresColumna = function(nombreColumna) {
        orig(nombreColumna);
        const modal = document.querySelector('.modal-overlay');
        if (modal) {
          const h3 = modal.querySelector('h3');
          if (h3) h3.textContent = `📋 Valores de "${nombreColumna}"`;
          const copiarBtn = Array.from(modal.querySelectorAll('button')).find(b => (b.textContent||'').toLowerCase().includes('copiar'));
          if (copiarBtn) copiarBtn.textContent = '📋 Copiar Valores';
        }
      };
    }
  });
})();
</script>
</body>
</html>

